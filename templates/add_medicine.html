{% extends "base.html" %}
{% block content %}
<h2>Add New Medicine</h2>
<form id="addForm">
  <div class="mb-3">
    <label>Name</label>
    <input type="text" id="name" class="form-control" required>
  </div>
  <div class="mb-3">
    <label>Batch Number</label>
    <input type="text" id="batch_number" class="form-control" required>
  </div>
  <div class="mb-3">
    <label>Expiry Date</label>
    <input type="date" id="expiry_date" class="form-control" required>
  </div>
  <div class="mb-3">
    <label>Quantity</label>
    <input type="number" id="quantity" class="form-control" required>
  </div>
  <div class="mb-3">
    <label>Supplier ID</label>
    <input type="number" id="supplier_id" class="form-control" required>
  </div>
  <div class="mb-3">
    <label>Category ID</label>
    <input type="number" id="category_id" class="form-control" required>
  </div>
  <div class="mb-3">
    <label>Price</label>
    <input type="number" id="price" class="form-control" step="0.01" required>
  </div>
  <button type="submit" class="btn btn-success">Add Medicine</button>
</form>

<script>
const API_BASE = "http://127.0.0.1:5000";

document.getElementById("addForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  // Read inputs explicitly — don't rely on global identifiers
  const nameEl = document.getElementById("name");
  const batchEl = document.getElementById("batch_number");
  const expiryEl = document.getElementById("expiry_date");
  const qtyEl = document.getElementById("quantity");
  const supplierEl = document.getElementById("supplier_id");
  const categoryEl = document.getElementById("category_id");
  const priceEl = document.getElementById("price");

  const data = {
    name: nameEl.value.trim(),
    batch_number: batchEl.value.trim(),
    expiry_date: expiryEl.value, // "YYYY-MM-DD"
    quantity: parseInt(qtyEl.value, 10) || 0,
    supplier_id: parseInt(supplierEl.value, 10) || null,
    category_id: parseInt(categoryEl.value, 10) || null,
    price: parseFloat(priceEl.value) || 0.0
  };

  // Basic client-side validation
  if (!data.name) {
    alert("Please enter a medicine name.");
    nameEl.focus();
    return;
  }
  if (!data.batch_number) {
    alert("Please enter a batch number.");
    batchEl.focus();
    return;
  }

  try {
    const res = await fetch(`${API_BASE}/medicines`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data),
    });

    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      console.error("❌ Error adding medicine (server):", err);
      alert("Error adding medicine: " + (err.error || res.statusText || "Unknown error"));
      return;
    }

    const result = await res.json();
    alert("✅ " + result.message);
    window.location.href = "/medicines_page";
  } catch (networkErr) {
    console.error("❌ Network error:", networkErr);
    alert("Network error — make sure the Flask server is running.");
  }
});
</script>

{% endblock %}
