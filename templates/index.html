{% extends "base.html" %}
{% block content %}
<h2 class="mb-3">üìä Medicine Management Dashboard</h2>

<div id="alerts" class="mb-4"></div>

<div class="row text-center mb-4">
  <div class="col">
    <div class="card bg-info text-white">
      <div class="card-body">Total: <span id="totalCount">0</span></div>
    </div>
  </div>
  <div class="col">
    <div class="card bg-danger text-white">
      <div class="card-body">Expired: <span id="expiredCount">0</span></div>
    </div>
  </div>
  <div class="col">
    <div class="card bg-warning text-dark">
      <div class="card-body">Low Stock: <span id="lowStockCount">0</span></div>
    </div>
  </div>
</div>

<canvas id="stockChart" width="400" height="200" class="mb-4"></canvas>

<h4>Medicine List</h4>
<input type="text" id="searchBox" placeholder="Search..." onkeyup="searchMedicine()" class="form-control mb-3">
<select id="expiryFilter" onchange="filterMedicines()" class="form-select mb-3">
  <option value="">All</option>
  <option value="expired">Expired</option>
  <option value="near">Near Expiry</option>
  <option value="low">Low Stock</option>
</select>

<table class="table table-bordered">
  <thead>
    <tr>
      <th>ID</th><th>Name</th><th>Batch</th><th>Expiry</th><th>Qty</th><th>Supplier</th><th>Actions</th>
    </tr>
  </thead>
  <tbody id="medicineTable"></tbody>
</table>
<div id="expiryAlert" class="alert alert-danger d-none" role="alert"></div>


<script>initDashboard();</script>
<script>
async function loadDashboardStats() {
  const res = await fetch('/dashboard-stats');
  const stats = await res.json();
  document.getElementById('totalCount').textContent = stats.total;
  document.getElementById('expiringCount').textContent = stats.expiring_soon;
  document.getElementById('stockCount').textContent = stats.low_stock;
}

// ‚úÖ Fetch medicines & stats
async function loadMedicines() {
  const res = await fetch('/medicines');
  const data = await res.json();
  const tbody = document.querySelector('#medicineTable tbody');
  tbody.innerHTML = '';

  data.forEach(med => {
    tbody.innerHTML += `
      <tr>
        <td>${med.medicine_id}</td>
        <td>${med.name}</td>
        <td>${med.batch_number || '-'}</td>
        <td>${med.expiry_date}</td>
        <td>${med.quantity}</td>
        <td>‚Çπ${med.price}</td>
        <td>
          <button class="btn btn-sm btn-warning" onclick="editMedicine(${med.medicine_id})">Edit</button>
          <button class="btn btn-sm btn-danger" onclick="deleteMedicine(${med.medicine_id})">Delete</button>
        </td>
      </tr>`;
  });

  // update stats
  loadDashboardStats();
}
</script>
<script>
async function showExpiryAlerts() {
  const res = await fetch('/medicines');
  const data = await res.json();
  const today = new Date();
  const soon = new Date();
  soon.setDate(today.getDate() + 30);
  const expiring = data.filter(m => new Date(m.expiry_date) <= soon);

  const alertBox = document.getElementById('expiryAlert');
  if (expiring.length > 0) {
    alertBox.textContent = `‚ö†Ô∏è ${expiring.length} medicines are expiring within 30 days!`;
    alertBox.classList.remove('d-none');
  } else {
    alertBox.classList.add('d-none');
  }
}

// Call this on page load
loadMedicines();
showExpiryAlerts();
</script>


{% endblock %}

